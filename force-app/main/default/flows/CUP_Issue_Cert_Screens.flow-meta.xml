<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <assignments>
        <name>Add_Cert_to_Collection</name>
        <label>Add Cert to Collection</label>
        <locationX>362</locationX>
        <locationY>542</locationY>
        <assignmentItems>
            <assignToReference>collectionTempCert</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>tempCert</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_through_campaign_members</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_to_Collection_Create_Users</name>
        <label>Add to Collection - Create Users</label>
        <locationX>547</locationX>
        <locationY>233</locationY>
        <assignmentItems>
            <assignToReference>collectionCreateUser</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>tempCampaignMembers</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_to_Text_String</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_to_Text_String</name>
        <label>Add to Text String</label>
        <locationX>411</locationX>
        <locationY>237</locationY>
        <assignmentItems>
            <assignToReference>testCreateUsers</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>createUserNames</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_through_campaign_members</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Create_Temp_Cert</name>
        <label>Create Temp Cert</label>
        <locationX>552</locationX>
        <locationY>550</locationY>
        <assignmentItems>
            <assignToReference>tempCert.OwnerId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Community_User_Record.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>tempCert.Awarded_To__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>tempCampaignMembers.ContactId</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>tempCert.Status__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Current</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>tempCert.Certificate_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>tempCampaignMembers.Campaign_End_Date__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>tempCert.Expiration_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>certExpiration</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>tempCert.Type__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>certType</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_Cert_to_Collection</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>User_exists</name>
        <label>User exists?</label>
        <locationX>546</locationX>
        <locationY>388</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Exists</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Community_User_Record</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Create_Temp_Cert</targetReference>
            </connector>
            <label>Exists</label>
        </rules>
        <rules>
            <name>Does_Not_Exist</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Community_User_Record</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Add_to_Collection_Create_Users</targetReference>
            </connector>
            <label>Does Not Exist</label>
        </rules>
    </decisions>
    <formulas>
        <name>certExpiration</name>
        <dataType>Date</dataType>
        <expression>DATE( 
(YEAR ({!tempCampaignMembers.Campaign_End_Date__c})+1),
12,31)</expression>
    </formulas>
    <formulas>
        <name>certType</name>
        <dataType>String</dataType>
        <expression>IF({!tempCampaignMembers.Campaign_Type__c}=&#39;Hiring Client - Certified User Program&#39;,
&#39;Certified User - Hiring Client&#39;,
&#39;Certified User - Contractor&#39;
)</expression>
    </formulas>
    <formulas>
        <name>createUserNames</name>
        <dataType>String</dataType>
        <expression>{!tempCampaignMembers.Contact.Full_Name__c} +&#39; - &#39; + {!tempCampaignMembers.Contact.Account_Name__c} + &#39;; &#39;</expression>
    </formulas>
    <interviewLabel>CUP - Issue Cert Screens {!$Flow.CurrentDateTime}</interviewLabel>
    <label>CUP - Issue Certs</label>
    <loops>
        <name>Loop_through_campaign_members</name>
        <label>Loop through campaign members</label>
        <locationX>187</locationX>
        <locationY>382</locationY>
        <assignNextValueToReference>tempCampaignMembers</assignNextValueToReference>
        <collectionReference>Get_Campaign_Members</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Get_Community_User_Record</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Create_Certs</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>Flow</processType>
    <recordCreates>
        <name>Create_Certs</name>
        <label>Create Certs</label>
        <locationX>352</locationX>
        <locationY>62</locationY>
        <connector>
            <targetReference>Records_Created</targetReference>
        </connector>
        <faultConnector>
            <targetReference>Error_Screen</targetReference>
        </faultConnector>
        <inputReference>collectionTempCert</inputReference>
    </recordCreates>
    <recordLookups>
        <description>Get all campaign members in an attended status for the campaign that kicked off the flow</description>
        <name>Get_Campaign_Members</name>
        <label>Get Campaign Members</label>
        <locationX>184</locationX>
        <locationY>230</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_through_campaign_members</targetReference>
        </connector>
        <filters>
            <field>CampaignId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>recordId</elementReference>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Attended</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>CampaignMember</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Community_User_Record</name>
        <label>Get Community User Record</label>
        <locationX>374</locationX>
        <locationY>386</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>User_exists</targetReference>
        </connector>
        <filters>
            <field>ContactId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>tempCampaignMembers.ContactId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>User</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <screens>
        <name>Confirm_Issuing_Certs</name>
        <label>Confirm Issuing Certs</label>
        <locationX>183</locationX>
        <locationY>50</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>Get_Campaign_Members</targetReference>
        </connector>
        <fields>
            <name>confirmCert</name>
            <fieldText>&lt;p&gt;Are you sure you would like to issue certificates for this certified user program Please confirm:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ol&gt;&lt;li&gt;All users have community access&lt;/li&gt;&lt;li&gt;All users &lt;i&gt;do not&lt;/i&gt; have an existing CUP certificate&lt;/li&gt;&lt;li&gt;The campaign end date is correct&lt;/li&gt;&lt;li&gt;All contacts who attended this session are in an &lt;b&gt;Attended&lt;/b&gt; campaign member status&lt;/li&gt;&lt;/ol&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Error_Screen</name>
        <label>Error Screen</label>
        <locationX>816</locationX>
        <locationY>46</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>true</allowPause>
        <fields>
            <name>displayError</name>
            <fieldText>&lt;p&gt;Oops! There was an issue with creating the certificates. Please contact the Salesforce Admin Team.&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Records_Created</name>
        <label>Records Created</label>
        <locationX>522</locationX>
        <locationY>52</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>true</allowPause>
        <fields>
            <name>congrats</name>
            <fieldText>&lt;p&gt;Congratulations! Records have been created.&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;The below contacts do not have certificates as they do not have access to a community.&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;{!testCreateUsers}&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <start>
        <locationX>50</locationX>
        <locationY>50</locationY>
        <connector>
            <targetReference>Confirm_Issuing_Certs</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <name>collectionCreateUser</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>CampaignMember</objectType>
    </variables>
    <variables>
        <name>collectionTempCert</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Certificate__c</objectType>
    </variables>
    <variables>
        <name>recordId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>tempCampaignMembers</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>CampaignMember</objectType>
    </variables>
    <variables>
        <name>tempCert</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Certificate__c</objectType>
    </variables>
    <variables>
        <name>testCreateUsers</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
