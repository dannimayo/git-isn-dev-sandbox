<apex:page standardController="Conference__c" extensions="FormsExtension_ConferenceChecklist" title="Conference Planning Checklist">
    <head>
        <title>Conference Planning Checklist</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-dateFormat/1.0/jquery.dateFormat.min.js"></script>
        <script>
            j$ = jQuery.noConflict();
            j$(document).ready(function() { 
                j$('[data-onload]').each(function(){
                    eval(j$(this).data('onload'));
                });
                j$('[data-onload]').change(function() {
                    var roId = j$(this).attr("id");
                    var anchor = "responseFor" + j$(this).attr("id");
                    if(this.checked) {
                        console.log(roId);
                        console.log(anchor);
                        if (roId.substr(0,2) == 'NA') {
                            addNAResponse(roId,anchor);
                        } else {
                            addResponse(roId,anchor);
                        }
                    } else {
                        deleteResponse(roId,anchor);
                    }
                });
            });
        function checkBox(id,boo) {
            j$('#' + id).prop("checked",boo);
        }
        </script>
        <script type="text/javascript">
            function addResponse(roId,anchor) {
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.FormsExtension_ConferenceChecklist.getResponse}',
                    roId,
                    '{!$CurrentPage.parameters.Id}',
                    function(result, event){
                        if (event.status) {
                            console.log(result);
                            // Get DOM IDs for HTML and Visualforce elements like this
                            var updatedBy = "Just Now by " + result.Owner.Name;
                            document.getElementById(anchor).innerHTML = updatedBy;
                        } else if (event.type === 'exception') {
                            console.log(event.message);
                        } else {
                            console.log(event.message);
                        }
                    }, 
                    {escape: true}
                );
            }
            function addNAResponse(roId,anchor) {
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.FormsExtension_ConferenceChecklist.getNAResponse}',
                    roId.substring(2),
                    '{!$CurrentPage.parameters.Id}',
                    function(result, event){
                        if (event.status) {
                            console.log(result);
                            // Get DOM IDs for HTML and Visualforce elements like this
                            var updatedBy = "Just Now by " + result.Owner.Name;
                            document.getElementById(anchor).innerHTML = updatedBy;
                        } else if (event.type === 'exception') {
                            console.log(event.message);
                        } else {
                            console.log(event.message);
                        }
                    }, 
                    {escape: true}
                );
            }
            function deleteResponse(roId,anchor) {
                var roDelete;
                if (roId.substring(0,2)=='NA') {
                    roDelete = roId.substring(2);
                } else {
                    roDelete = roId;
                }
                console.log(roDelete);
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.FormsExtension_ConferenceChecklist.deleteResponse}',
                    roDelete,
                    '{!$CurrentPage.parameters.Id}',
                    function(result, event){
                        if (event.status) {
                            console.log(result);
                            // Get DOM IDs for HTML and Visualforce elements like this
                            var updatedBy = "Removed";
                            console.log(anchor);
                            document.getElementById(anchor).innerHTML = updatedBy;
                        } else if (event.type === 'exception') {
                            console.log(event.message);
                        } else {
                            console.log(event.message);
                        }
                    }, 
                    {escape: true}
                );
            }
        </script>
        <style>
            table.checklist {
              width: 100%;
            }
            td.checklistItems {
                white-space: normal !important;
                vertical-align: middle !important;
            }
            .updatedby {
                font-size: 10pt;
            }
        </style>
        <apex:slds />
    </head>
    <div id="responseErrors">
        
    </div>
    <div class="slds-scope">
        <div class="slds-box">
            <div class="slds-page-header">
                <apex:form id="headerForm" >
                <div class="slds-grid">
                    <div class="slds-col slds-has-flexi-truncate">
                        <div class="slds-media slds-no-space slds-grow">
                            <div class="slds-media__figure">
                            </div>
                            <div class="slds-media__body">
                                <p class="slds-text-title--caps slds-line-height--reset">Conference Planning Checklist</p>
                                <h1 class="slds-page-header__title slds-m-right--small slds-align-middle slds-truncate" title="Conference Checklist">{!Conference__c.Name}</h1>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="viewPanel">
                    <ul class="slds-grid slds-page-header__detail-row">
                        <li class="slds-page-header__detail-block">
                            <p class="slds-text-title slds-truncate slds-m-bottom--xx-small" title="Conference Name">Conference Name</p>
                            <a href="/{!Conference__c.Id}"><apex:outputField styleClass="slds-text-body--regular slds-truncate" value="{!Conference__c.Name}"/></a>
                        </li>
                        <li class="slds-page-header__detail-block">
                            <p class="slds-text-title slds-truncate slds-m-bottom--xx-small" title="Start Date">Start Date</p>
                            <apex:outputField styleClass="slds-text-body--regular slds-truncate" value="{!Conference__c.Start_Date__c}"/>
                        </li>
                        <li class="slds-page-header__detail-block">
                            <p class="slds-text-title slds-truncate slds-m-bottom--xx-small" title="End Date">End Date</p>
                            <apex:outputField styleClass="slds-text-body--regular slds-truncate" value="{!Conference__c.End_Date__c}"/>
                        </li>
                        <li class="slds-page-header__detail-block">
                            <p class="slds-text-title slds-truncate slds-m-bottom--xx-small" title="ISN Lead Contact">ISN Lead Contact</p>
                            <apex:outputField styleClass="slds-text-body--regular slds-truncate" value="{!Conference__c.ISN_Lead_Contact_Old__c}"/>
                        </li>
                        <li class="slds-page-header__detail-block">
                            <p class="slds-text-title slds-truncate slds-m-bottom--xx-small" title="Status">Status</p>
                            <apex:outputField styleClass="slds-text-body--regular slds-truncate" value="{!Conference__c.Status__c}"/>
                        </li>
                    </ul>
                </div>
                </apex:form>
            </div>
        </div>
        <apex:outputPanel rendered="{!IF(OR(Conference__c.Status__c == 'Approved',Conference__c.Status__c == 'Approved (Scheduled)',Conference__c.Status__c == 'Attended'),true,false)}">
        <div class="slds-tabs--scoped">
            <ul class="slds-tabs--scoped__nav" role="tablist">
                <li class="slds-tabs--scoped__item slds-active" title="Checklist" role="presentation"><a class="slds-tabs--scoped__link" href="javascript:void(0);" role="tab" tabindex="0" aria-selected="true" aria-controls="tab-scoped-1" id="tab-scoped-1__item">Checklist</a></li>
                <li class="slds-tabs--scoped__item" title="Notes & Attachments" role="presentation"><a class="slds-tabs--scoped__link" href="javascript:void(0);" role="tab" tabindex="-1" aria-selected="false" aria-controls="tab-scoped-2" id="tab-scoped-2__item">Notes &amp; Attachments <apex:outputtext value=" ({!IF(Conference__c.Attachment_Count__c==null,0,ROUND(Conference__c.Attachment_Count__c,0))})"/></a></li>
            </ul>
            <div id="tab-scoped-1" class="slds-tabs--scoped__content slds-show" role="tabpanel" aria-labelledby="tab-scoped-1__item">
                <apex:form id="editForm">
                    <table class="slds-table slds-table--bordered slds-table--cell-buffer slds-table--col-bordered checklist">
                        <apex:repeat value="{!questionResponseMap}" var="key">
                            <tr class="slds-text-title--caps">
                                <th colspan="2" class="slds-text-title--caps slds-has-focus" width="70%" style="background:#f4f6f9;" scope="col">{!key}</th>
                                <th class="slds-text-title--caps slds-has-focus" width="10%" style="background:#f4f6f9;" scope="col">Responsible Party</th>
                                <th class="slds-text-title--caps slds-has-focus" width="10%" style="background:#f4f6f9;" scope="col">Completed</th>
                                <th class="slds-text-title--caps slds-has-focus" width="10%" style="background:#f4f6f9;" scope="col">N/A</th>
                            </tr>
                            <apex:repeat value="{!questionResponseMap[key]}" var="q">
                                <tr>    
                                    <td width="3%" class="checklistItems">
                                        {!q.Question_Number__c}
                                    </td>
                                    <td width="67%" class="checklistItems">
                                        <apex:outputText escape="false" value="{!q.Question_Text__c}"/>
                                    </td>
                                    <td width="10%" class="checklistItems">
                                        <apex:outputText escape="false" value="{!q.Responsible_Party__c}"/>
                                    </td>
                                    <apex:repeat value="{!q.Response_Options__r}" var="ro" id="theRepeater">
                                    <apex:outputPanel rendered="{!IF(ro.Correct_Reponse__c==True,True,False)}">
                                    <td width="10%" class="checklistItems">
                                        <fieldset class="slds-form-element">
                                            
                                                <div class="slds-form-element__control" >
                                                    <span class="{!IF(q.Type__c=="CheckboxSelectOne","slds-radio",IF(q.Type__c=="Acknowledgement","slds-checkbox",""))}">
                                                        <input type="{!IF(q.Type__c=="CheckboxSelectOne","radio",IF(q.Type__c=="Acknowledgement","checkbox",""))}" id="{!ro.Name}" name="{!q.Name}" data-onload="checkBox('{!ro.Name}',{!IF(CONTAINS(responseKeys,q.name),true,false)})" display="{!IF(CONTAINS(responseKeys,q.name),'none','')}"/>
                                                        <label class="{!IF(q.Type__c=="CheckboxSelectOne","slds-radio__label",IF(q.Type__c=="Acknowledgement","slds-checkbox__label",""))}" for="{!ro.Name}">
                                                            <span class="{!IF(q.Type__c=="CheckboxSelectOne","slds-radio--faux",IF(q.Type__c=="Acknowledgement","slds-checkbox--faux",""))}" display="{!IF(CONTAINS(responseKeys,q.name),'none','')}"></span>
                                                            <span class="slds-form-element__label">
                                                                <span id="responseFor{!ro.Name}" class="updatedby">
                                                                    <apex:outputText value="{0,date,MMM d, yyyy}{!IF(CONTAINS(responseKeys,q.name),' by ' & responses[q.name].Owner.Name,'')}">
                                                                        <apex:param value="{!IF(CONTAINS(responseKeys,q.name),responses[q.name].Completed_Date__c,'')}"/>
                                                                    </apex:outputText>
                                                                </span>
                                                            </span>
                                                        </label>
                                                    </span>
                                                </div>
                                            
                                        </fieldset>
                                    </td>
                                    </apex:outputPanel>
                                    </apex:repeat>
                                    <apex:repeat value="{!q.Response_Options__r}" var="ro" id="theNARepeater">
                                    <apex:outputPanel rendered="{!IF(ro.Correct_Reponse__c==False,True,False)}">
                                    <td width="10%" class="checklistItems">
                                        <fieldset class="slds-form-element">
                                            
                                                <div class="slds-form-element__control" >
                                                    <span class="{!IF(q.Type__c=="CheckboxSelectOne","slds-radio",IF(q.Type__c=="Acknowledgement","slds-checkbox",""))}">
                                                        <input type="{!IF(q.Type__c=="CheckboxSelectOne","radio",IF(q.Type__c=="Acknowledgement","checkbox",""))}" id="NA{!ro.Name}" name="{!q.Name}" data-onload="checkBox('NA{!ro.Name}',{!IF(CONTAINS(NAresponseKeys,q.name),true,false)})" display="{!IF(CONTAINS(NAresponseKeys,q.name),'none','')}"/>
                                                        <label class="{!IF(q.Type__c=="CheckboxSelectOne","slds-radio__label",IF(q.Type__c=="Acknowledgement","slds-checkbox__label",""))}" for="NA{!ro.Name}">
                                                            <span class="{!IF(q.Type__c=="CheckboxSelectOne","slds-radio--faux",IF(q.Type__c=="Acknowledgement","slds-checkbox--faux",""))}" display="{!IF(CONTAINS(NAresponseKeys,q.name),'none','')}"></span>
                                                            <span class="slds-form-element__label">
                                                                <span id="responseForNA{!ro.Name}" class="updatedby">
                                                                    <apex:outputText value="{0,date,MMM d, yyyy}{!IF(CONTAINS(NAresponseKeys,q.name),' by ' & NAresponses[q.name].Owner.Name,'')}">
                                                                        <apex:param value="{!IF(CONTAINS(NAresponseKeys,q.name),NAresponses[q.name].Completed_Date__c,'')}"/>
                                                                    </apex:outputText>
                                                                </span>
                                                            </span>
                                                        </label>
                                                    </span>
                                                </div>
                                            
                                        </fieldset>
                                    </td>
                                    </apex:outputPanel>
                                    </apex:repeat>
                                </tr>
                            </apex:repeat>
                        </apex:repeat>
                    </table>
                </apex:form>
            </div>
            <div id="tab-scoped-2" class="slds-tabs--scoped__content slds-hide" role="tabpanel" aria-labelledby="tab-scoped-2__item">
                <apex:relatedList subject="{!Conference__c}" list="CombinedAttachments" />
            </div>
        </div>
        </apex:outputPanel>
        <apex:outputPanel rendered="{!IF(AND(Conference__c.Status__c != 'Approved',Conference__c.Status__c != 'Approved (Scheduled)',Conference__c.Status__c != 'Attended'),true,false)}">
            Conference must be approved to activate the checklist.
        </apex:outputPanel>
    </div>
    <script>
    
    /*SLDS Tabs JS*/
    j$('.slds-tabs--default__link,.slds-tabs--scoped__link').click(function(){
        j$(this).parent().parent().find('.slds-tabs--default__link,.slds-tabs--scoped__link').attr('aria-selected','false');
        j$(this).attr('aria-selected','true');
        j$(this).parent().parent().find('.slds-tabs--default__link,.slds-tabs--scoped__link').attr('tabindex','-1');
        j$(this).attr('tabindex','0');
        j$(this).parent().addClass('slds-active').siblings().removeClass('slds-active');
        j$(this).parent().parent().parent().find('.'+j$(this).parent().parent().parent().find('.slds-tabs--default__content,.slds-tabs--scoped__content')[0].classList[0]).removeClass('slds-show').addClass('slds-hide');
        j$(this).parent().parent().parent().find('#'+j$(this).attr('aria-controls')).removeClass('slds-hide').addClass('slds-show');
    }); 
    /*SLDS Tabs JS*/
    
    </script>
</apex:page>